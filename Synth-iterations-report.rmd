---
title: "Model-testing iterations"
author: "Andrew Baxter"
date: "19/09/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, error = FALSE, warning = FALSE, fig.width = 10, fig.height = 7)

library(dplyr)
library(svglite)
library(tidyr)
library(ggplot2)
library(SPHSUgraphs)
library(purrr)
library(ggrepel)
load('Data/synth_data_b.rdata') # outputted from 'Synth_data.R'
load("Data/filtered_itsp.rdata")  # outputted from 'Synth_create_sps.R'
load("Data/iterating_rm_countries_filt.rdata")
source('R/Synth_functions.R')
`-.gg` <- function(e1, e2) e2(e1)
```


# Under-18 pregnancy - no added predictors

Plotting MSPEs by iteration and gaps for all iterations.

```{r it_u18_plots}
gr_it_u18_filt <- plotIterations(it_u18_filt)  %>% annotate_figure(top = text_grob("Under-18, no predictors - year iterations"))
gr_it_u18_filt
```

## Top countries

Differing iterations produced different country weightings. I exctracted the top country for each iteration and plotted the lowest MSPE for the top four countries:

```{r it_u18_tops}
gr_tops_u18_filt <- plotIterations(it_u18_filt, labels = TRUE)  %>% annotate_figure(top = text_grob("Under-18, no predictors - year iterations"))
gr_tops_u18_filt
```

## Removing top countries

A further iterative cycle constructed sequential synthetic controls, removing the previous top-weighted country to test for over-reliance on very few abnormal countries:

```{r itco_u18_sp}
gr_itco_u18_filt <- gg_iterateCountries(itco_u18_filt)
gr_itco_u18_filt
```

# Under-20 - no added predictors

```{r it_u20_plots}
gr_it_u20_filt <- plotIterations(it_u20_filt)  %>% annotate_figure(top = text_grob("Under-20, no predictors - year iterations"))
gr_it_u20_filt
```

## Top Countries

```{r it_u20_tops}
gr_tops_u20_filt <- plotIterations(it_u20_filt, labels = TRUE)  %>% annotate_figure(top = text_grob("Under-20, no predictors - year iterations"))
gr_tops_u20_filt
```

## Removing Top Countries

```{r itco_u20_filt}
gr_itco_u20_filt <- gg_iterateCountries(itco_u20_filt)
gr_itco_u20_filt
```